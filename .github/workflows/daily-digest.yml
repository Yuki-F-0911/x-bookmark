name: X Bookmark Daily Digest

on:
  # bookmarks.json が更新されたら即座に実行
  push:
    paths:
      - "bookmarks.json"

  # 毎日 JST 7:00（UTC 22:00 前日）にも実行
  schedule:
    - cron: "0 22 * * *"

  # 手動実行ボタン
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Slack送信をスキップ（テスト用）"
        type: boolean
        default: false
      no_cache:
        description: "処理済みIDキャッシュを無視して全件処理"
        type: boolean
        default: false
      max_items:
        description: "処理する最大件数（デフォルト: 30）"
        type: string
        default: "30"
      skip_enrich:
        description: "Web検索補足をスキップ（高速化）"
        type: boolean
        default: false

jobs:
  digest:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check bookmarks.json exists and is not empty
        id: check_bookmarks
        run: |
          if [ ! -f "bookmarks.json" ]; then
            echo "bookmarks.json が存在しません。スキップします。"
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ ! -s "bookmarks.json" ]; then
            echo "bookmarks.json が空です。スキップします。"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "bookmarks.json を確認しました。処理を続行します。"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Run digest
        if: steps.check_bookmarks.outputs.skip != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          MAX_ITEMS: ${{ github.event.inputs.max_items || '30' }}
          SKIP_ENRICH: ${{ github.event.inputs.skip_enrich || 'false' }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "${{ github.event.inputs.no_cache }}" = "true" ]; then
            ARGS="$ARGS --no-cache"
          fi
          python -m src.main $ARGS

      # 処理済みIDキャッシュ＆ダイジェストキャッシュを自動コミットして保存
      - name: Save caches
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add processed_ids.json digest_cache.json || true
          git diff --staged --quiet || git commit -m "chore: update caches [skip ci]"
          git push || true

      # 失敗時に Slack にエラー通知
      - name: Notify failure to Slack
        if: failure()
        run: |
          curl -s -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": ":red_circle: *X Bookmark Digest が失敗しました*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ログを確認>"
            }'
